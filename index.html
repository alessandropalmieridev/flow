<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pomodoro Timer</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css" />
    <link rel="icon" type="image/svg+xml" href="../icon.svg" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #1c1c1e;
        color: #f5f5f7;
      }

      #startStop,
      #startStop:hover,
      #startStop:focus,
      #startStop:active {
        background-color: inherit !important;
        border: 4px solid #ff9500;
        border-radius: 100%;
        width: 80px;
        height: 80px;
        box-shadow: none !important;
        outline: none !important;
        cursor: pointer !important;
      }
      #startStop i {
        color: #ff9500 !important;
      }

      #countdown {
        font-size: 64px;
        font-weight: 700;
        margin: 10px 0;
      }

      #phaseLabel {
        font-size: 42px;
        font-weight: 700;
        margin-bottom: 20px;
        transition: color 0.2s ease;
      }

      .phase-flow {
        color: #007aff;
      }
      .phase-rest {
        color: #ff3b30;
      }
      .phase-idle {
        color: #f5f5f7;
      }

      input[type="number"] {
        background: transparent;
        color: #f5f5f7;
        border: none;
        border-bottom: 1px solid #6e6e73;
        font-size: 18px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input[type="number"]:focus {
        outline: none;
        border-color: #007aff;
        box-shadow: 0 2px 0 0 #007aff33;
      }
    </style>
  </head>
  <body>
    <div class="w3-display-container w3-margin" style="height: 100vh">
      <!-- Settings -->
      <div class="w3-display-left">
        <div>
          <label for="flowMinutes">Flow</label><br />
          <input
            id="flowMinutes"
            type="number"
            min="1"
            value="52"
            style="width: 50%"
          />
        </div>
        <div class="w3-margin-top">
          <label for="restMinutes">Rest</label><br />
          <input
            id="restMinutes"
            type="number"
            min="1"
            value="17"
            style="width: 50%"
          />
        </div>
      </div>

      <!-- Timer -->
      <div class="w3-display-middle w3-center">
        <div>
          <button class="w3-button w3-xxlarge" id="startStop">
            <i class="fa fa-play" id="buttonIcon"></i>
          </button>
        </div>
        <div><label id="countdown">00:00</label></div>
        <div><label id="phaseLabel" class="phase-idle">IDLE</label></div>

        <!-- Validaton script -->
        <script>
          let startButtonAppearence = document.getElementById("startStop");
          const flowInput = document.getElementById("flowMinutes");
          const restInput = document.getElementById("restMinutes");
          function validateInputs() {
            //a cooler way to write the function function -- const isValid = v => v !== null && v !== undefined && v !== "" && !isNaN(v) && Number.isInteger(Number(v)) && v >= 1;
            function isValid(v) {
              return (
                v !== null &&
                v !== undefined &&
                v !== "" &&
                !isNaN(v) &&
                Number.isInteger(Number(v)) &&
                v >= 1
              );
            }
            if (!isValid(flowInput.value) || !isValid(restInput.value)) {
              startButtonAppearence.disabled = true;
            } else {
              startButtonAppearence.disabled = false;
            }
          }
          flowInput.addEventListener("input", validateInputs);
          restInput.addEventListener("input", validateInputs);
          validateInputs();
        </script>
      </div>

      <!-- Stats -->
      <div class="w3-display-right w3-center">
        <div>
          <div class="w3-xlarge" id="cycles">0</div>
          <div>Cycles</div>
        </div>
        <div class="w3-margin-top">
          <div class="w3-xlarge" id="totalTime">0h 0m</div>
          <div>Worked</div>
        </div>
      </div>
    </div>

    <script>
      const startStopBtn = document.getElementById("startStop");
      const buttonIcon = document.getElementById("buttonIcon");

      const phaseLabel = document.getElementById("phaseLabel");
      const countdownEl = document.getElementById("countdown");
      const cyclesEl = document.getElementById("cycles");
      const totalTimeEl = document.getElementById("totalTime");

      let running = false,
        phase = "idle",
        remaining = 0,
        timer = null;
      let cycles = 0,
        totalSeconds = 0,
        lastTick = null;

      function beep() {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.type = "sine";
          osc.frequency.value = 880;
          osc.start();
          gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.5);
          osc.stop(ctx.currentTime + 0.5);
        } catch (e) {
          console.log("Beep non supportato", e);
        }
      }

      function fmt(s) {
        const m = Math.floor(s / 60)
          .toString()
          .padStart(2, "0");
        const sec = Math.floor(s % 60)
          .toString()
          .padStart(2, "0");
        return `${m}:${sec}`;
      }

      function fmtTotal(s) {
        const h = Math.floor(s / 3600),
          m = Math.floor((s % 3600) / 60);
        return `${h}h ${m}m`;
      }

      function setPhase(newPhase, minutes) {
        phase = newPhase;
        remaining = minutes * 60;
        phaseLabel.className =
          newPhase === "flow"
            ? "phase-flow"
            : newPhase === "rest"
            ? "phase-rest"
            : "phase-idle";
        phaseLabel.textContent = newPhase.toUpperCase() || "IDLE";
        countdownEl.textContent = fmt(remaining);
        beep();
      }

      function updateMeta() {
        cyclesEl.textContent = cycles;
        totalTimeEl.textContent = fmtTotal(totalSeconds);
      }

      function tick() {
        const now = Date.now();
        if (!lastTick) lastTick = now;
        const delta = (now - lastTick) / 1000;
        lastTick = now;
        remaining -= delta;
        if (remaining < 0) remaining = 0;
        totalSeconds += delta;
        countdownEl.textContent = fmt(remaining);
        updateMeta();

        if (remaining <= 0) {
          if (phase === "flow")
            setPhase("rest", parseInt(restInput.value) || 15);
          else if (phase === "rest") {
            cycles++;
            setPhase("flow", parseInt(flowInput.value) || 45);
          }
        }
      }

      function start() {
        setPhase("flow", parseInt(flowInput.value) || 45);
        running = true;
        cycles = 0;
        totalSeconds = 0;
        lastTick = null;
        timer = setInterval(tick, 200);
        buttonIcon.className = "fa fa-stop";
        flowInput.disabled = restInput.disabled = true;
      }

      function stop(reset = true) {
        clearInterval(timer);
        timer = null;
        running = false;
        buttonIcon.className = "fa fa-play";
        flowInput.disabled = restInput.disabled = false;
        if (reset) {
          cycles = 0;
          totalSeconds = 0;
          setPhase("idle", 0);
          updateMeta();
        }
      }

      startStopBtn.onclick = () => (running ? stop(true) : start());
    </script>
  </body>
</html>
