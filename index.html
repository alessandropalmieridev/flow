<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="../icon.svg" />
    <title>Pomodoro Timer</title>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* ------------------------ */
      /* Base e Font               */
      /* ------------------------ */
      body,
      html {
        height: 100%;
        margin: 0;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, sans-serif;
        background-color: #1c1c1e;
        color: #f5f5f7;
      }

      /* ------------------------ */
      /* Layout                   */
      /* ------------------------ */
      .container {
        display: flex;
        height: 100vh;
        width: 100%;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
      }

      .column {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .center-column {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }

      /* ------------------------ */
      /* Inputs                   */
      /* ------------------------ */
      label {
        font-weight: 600;
        color: #6e6e73;
        font-size: 14px;
        margin-bottom: 4px;
      }

      input[type="number"] {
        background: transparent;
        color: #f5f5f7;
        border: none;
        border-bottom: 1px solid #6e6e73;
        padding: 6px 4px;
        font-size: 18px;
        width: 60px;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input[type="number"]:focus {
        outline: none;
        border-color: #007aff;
        box-shadow: 0 2px 0 0 #007aff33;
      }

      /* ------------------------ */
      /* Pulsante Play/Stop       */
      /* ------------------------ */
      #startStop {
        background-color: #007aff;
        border: none;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: box-shadow 0.2s ease, background-color 0.2s ease;
      }

      #startStop i {
        color: #f5f5f7;
        font-size: 32px;
      }

      #startStop:focus {
        outline: none;
        box-shadow: 0 0 0 6px rgba(0, 122, 255, 0.3);
      }

      #startStop:hover,
      #startStop:active {
        background-color: #007aff;
        box-shadow: 0 0 0 6px rgba(0, 122, 255, 0.3);
      }

      /* ------------------------ */
      /* Timer e Fase             */
      /* ------------------------ */
      #countdown {
        font-size: 64px;
        font-weight: 700;
        transition: color 0.3s ease;
      }

      #phaseLabel {
        font-size: 42px;
        font-weight: 700;
        letter-spacing: 2px;
        transition: color 0.3s ease;
      }

      .phase-flow {
        color: #007aff;
      }
      .phase-rest {
        color: #ff3b30;
      }
      .phase-idle {
        color: #f5f5f7;
      }

      /* ------------------------ */
      /* Stats (Cicli / Tempo)    */
      /* ------------------------ */
      .value {
        font-size: 22px;
        font-weight: 600;
        text-align: center;
      }

      .label {
        font-size: 14px;
        color: #6e6e73;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Setting column -->
      <div class="column">
        <div>
          <label for="flowMinutes">Flow</label>
          <input id="flowMinutes" type="number" min="1" value="52" />
        </div>
        <div>
          <label for="restMinutes">Rest</label>
          <input id="restMinutes" type="number" min="1" value="17" />
        </div>
      </div>

      <!-- Timer column -->
      <div class="center-column">
        <button id="startStop">
          <i class="fa fa-play" id="buttonIcon"></i>
        </button>
        <div id="countdown">00:00</div>
        <div id="phaseLabel" class="phase-idle">IDLE</div>
      </div>

      <!-- Stats column -->
      <div class="column">
        <div>
          <div class="value" id="cycles">0</div>
          <div class="label">Cicli completati</div>
        </div>
        <div>
          <div class="value" id="totalTime">0h 0m</div>
          <div class="label">Tempo totale</div>
        </div>
      </div>
    </div>

    <script>
      const flowInput = document.getElementById("flowMinutes");
      const restInput = document.getElementById("restMinutes");
      const startStopBtn = document.getElementById("startStop");
      const buttonIcon = document.getElementById("buttonIcon");

      const phaseLabel = document.getElementById("phaseLabel");
      const countdownEl = document.getElementById("countdown");
      const cyclesEl = document.getElementById("cycles");
      const totalTimeEl = document.getElementById("totalTime");

      let running = false,
        phase = "idle",
        remaining = 0,
        timer = null;
      let cycles = 0,
        totalSeconds = 0,
        lastTick = null;

      function beep() {
        try {
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.type = "sine";
          osc.frequency.value = 880;
          osc.start();
          gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.5);
          osc.stop(ctx.currentTime + 0.5);
        } catch (e) {
          console.log("Beep non supportato", e);
        }
      }

      function fmt(s) {
        const m = Math.floor(s / 60)
          .toString()
          .padStart(2, "0");
        const sec = Math.floor(s % 60)
          .toString()
          .padStart(2, "0");
        return `${m}:${sec}`;
      }

      function fmtTotal(s) {
        const h = Math.floor(s / 3600),
          m = Math.floor((s % 3600) / 60);
        return `${h}h ${m}m`;
      }

      function setPhase(newPhase, minutes) {
        phase = newPhase;
        remaining = minutes * 60;
        if (newPhase === "flow") {
          phaseLabel.textContent = "FLOW";
          phaseLabel.className = "phase-flow";
        } else if (newPhase === "rest") {
          phaseLabel.textContent = "REST";
          phaseLabel.className = "phase-rest";
        } else {
          phaseLabel.textContent = "IDLE";
          phaseLabel.className = "phase-idle";
        }
        countdownEl.textContent = fmt(remaining);
        beep();
      }

      function updateMeta() {
        cyclesEl.textContent = cycles;
        totalTimeEl.textContent = fmtTotal(totalSeconds);
      }

      function tick() {
        const now = Date.now();
        if (lastTick === null) lastTick = now;
        const delta = (now - lastTick) / 1000;
        lastTick = now;
        remaining -= delta;
        if (remaining < 0) remaining = 0;
        totalSeconds += delta;
        countdownEl.textContent = fmt(remaining);
        updateMeta();

        if (remaining <= 0) {
          if (phase === "flow")
            setPhase("rest", parseInt(restInput.value) || 15);
          else if (phase === "rest") {
            cycles++;
            setPhase("flow", parseInt(flowInput.value) || 45);
          }
        }
      }

      function start() {
        setPhase("flow", parseInt(flowInput.value) || 45);
        running = true;
        cycles = 0;
        totalSeconds = 0;
        lastTick = null;
        timer = setInterval(tick, 200);
        buttonIcon.className = "fa fa-stop";
        flowInput.disabled = restInput.disabled = true;
      }

      function stop(reset = true) {
        clearInterval(timer);
        timer = null;
        running = false;
        buttonIcon.className = "fa fa-play";
        flowInput.disabled = restInput.disabled = false;
        if (reset) {
          cycles = 0;
          totalSeconds = 0;
          setPhase("idle", 0);
          updateMeta();
        }
      }

      startStopBtn.onclick = () => {
        running ? stop(true) : start();
      };

      function validateInputs() {
        function isValid(v) {
          return (
            v !== null &&
            v !== undefined &&
            v !== "" &&
            !isNaN(v) &&
            Number.isInteger(Number(v)) &&
            v >= 1
          );
        }
        startStopBtn.disabled =
          !isValid(flowInput.value) || !isValid(restInput.value);
      }

      flowInput.addEventListener("input", validateInputs);
      restInput.addEventListener("input", validateInputs);
      validateInputs();

      setPhase("idle", 0);
      updateMeta();
    </script>
  </body>
</html>
